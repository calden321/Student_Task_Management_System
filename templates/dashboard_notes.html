{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="task-list">
        <!-- Search Bar -->
        <div class="search-bar" style="margin-bottom: 1rem;">
            <form method="GET" action="/dashboard">
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" name="search" placeholder="ğŸ” Search tasks, notes..." 
                           value="{{ search_query }}" 
                           style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 3px;">
                    <input type="hidden" name="subject" value="{{ subject_filter }}">
                    <button type="submit" class="btn btn-primary">Search</button>
                    {% if search_query %}
                    <a href="/dashboard?subject={{ subject_filter }}" class="btn">Clear</a>
                    {% endif %}
                </div>
            </form>
        </div>

        <!-- QUICK TASK SECTION - ADDED HERE -->
        <div style="background: #e8f5e8; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #4CAF50;">
            <h3 style="margin: 0 0 1rem 0; color: #2e7d32;">âš¡ Quick Add Task</h3>
            <form method="POST" action="/quick_task" style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                <input type="text" name="title" placeholder="What do you need to do?" 
                       style="flex: 1; min-width: 200px; padding: 0.7rem; border: 1px solid #ccc; border-radius: 5px;" required>
                
                <select name="due_days" style="padding: 0.7rem; border: 1px solid #ccc; border-radius: 5px;">
                    <option value="0">ğŸ“… Today</option>
                    <option value="1">ğŸ“… Tomorrow</option>
                    <option value="3">ğŸ“… In 3 days</option>
                    <option value="7">ğŸ“… Next week</option>
                </select>
                
                <button type="submit" style="background: #4CAF50; color: white; border: none; padding: 0.7rem 1.5rem; border-radius: 5px; cursor: pointer; font-weight: bold;">
                    + Add Task
                </button>
            </form>
        </div>

        <h2>Your Tasks 
            <small>
                <a href="/dashboard?subject=all&search={{ search_query }}" 
                   style="{% if subject_filter == 'all' %}font-weight:bold;{% endif %}">
                   All
                </a>
                {% for subject in subjects %}
                | <a href="/dashboard?subject={{ subject.name }}&search={{ search_query }}" 
                     style="{% if subject_filter == subject.name %}font-weight:bold;{% endif %}">
                     {{ subject.name }}
                   </a>
                {% endfor %}
            </small>
        </h2>
        
        <div class="stats">
            <p><strong>ğŸ“Š Summary:</strong> {{ total_tasks }} total tasks | {{ completed_tasks }} completed | {{ pending_tasks }} pending</p>
            {% if subject_filter != 'all' %}
            <p>Filtered by: <strong>{{ subject_filter }}</strong></p>
            {% endif %}
            {% if search_query %}
            <p>Search results for: <strong>"{{ search_query }}"</strong></p>
            {% endif %}
        </div>

        <!-- Export Section -->
        <div class="export-options" style="margin: 1rem 0; padding: 1rem; background: #f0f0f0; border-radius: 5px;">
            <p><strong>ğŸ“¤ Export Options:</strong></p>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <a href="/export/txt?subject={{ subject_filter }}&search={{ search_query }}" 
                   class="btn" style="background: #2196F3; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 3px;">
                    ğŸ“„ Download Text File
                </a>
                <a href="/print-view" 
                   class="btn" style="background: #4CAF50; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 3px;">
                    ğŸ–¨ï¸ Print View
                </a>
                <button onclick="window.print()" 
                        class="btn" style="background: #FF9800; color: white; border: none; padding: 0.5rem 1rem; border-radius: 3px; cursor: pointer;">
                    ğŸ–¨ï¸ Print This Page
                </button>
            </div>
        </div>
        
        {% if tasks %}
            {% for task in tasks %}
            <div class="task-item {{ task.priority }} {{ get_urgency_class(task.due_date) }} {% if task.completed %}completed{% endif %}">
                <h3>
                    <a href="/task_details/{{ task.id }}" style="text-decoration: none; color: inherit;">
                        {{ task.title }}
                    </a>
                    {% if not task.completed %}
                        {% set urgency_class = get_urgency_class(task.due_date) %}
                        {% if urgency_class == 'urgent-overdue' %}
                            <span class="urgency-badge overdue-badge">OVERDUE!</span>
                        {% elif urgency_class == 'urgent-today' %}
                            <span class="urgency-badge today-badge">DUE TODAY</span>
                        {% elif urgency_class == 'urgent-tomorrow' %}
                            <span class="urgency-badge tomorrow-badge">DUE TOMORROW</span>
                        {% endif %}
                    {% endif %}
                </h3>
                
                <p>{{ task.description }}</p>
                
                {% if task.notes %}
                <div style="background: #f0f8ff; padding: 0.5rem; border-radius: 3px; margin: 0.5rem 0; border-left: 3px solid #4CAF50;">
                    <strong>ğŸ“ Latest Note:</strong>
                    <p style="margin: 0.2rem 0; font-size: 0.9em;">{{ task.notes.split('\n')[-1]|replace('] ', ']: ')|truncate(100) }}</p>
                    <small><a href="/task_details/{{ task.id }}">View all notes</a></small>
                </div>
                {% endif %}
                
                <p>
                    ğŸ“… Due: {{ task.due_date }} | 
                    <span class="priority-badge {{ task.priority }}-badge">{{ task.priority.upper() }}</span> |
                    {% if task.subject_name %}
                    <span style="color: {{ task.subject_color }};">ğŸ“š {{ task.subject_name }}</span> |
                    {% endif %}
                    Status: {% if task.completed %}âœ… Completed{% else %}â³ Pending{% endif %}
                </p>
               <div>
    {% if not task.completed %}
    <form method="POST" action="/complete_task" style="display:inline;">
        <input type="hidden" name="task_id" value="{{ task.id }}">
        <button type="submit" class="btn btn-success">âœ“ Mark Complete</button>
    </form>
    {% endif %}
    
    <a href="/task_details/{{ task.id }}" class="btn" style="background: #2196F3; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 3px;">
        ğŸ“ Notes
    </a>
    
    <form method="POST" action="/delete_task" style="display:inline;">
        <input type="hidden" name="task_id" value="{{ task.id }}">
        <button type="submit" class="btn btn-danger">Delete</button>
    </form>
</div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 2rem; background: #f9f9f9; border-radius: 5px;">
                <p style="font-size: 1.2rem;">ğŸ” No tasks found</p>
                {% if search_query %}
                <p>No tasks match your search for <strong>"{{ search_query }}"</strong></p>
                <p><a href="/dashboard?subject={{ subject_filter }}">Show all tasks</a></p>
                {% else %}
                <p>No tasks yet. Add your first task below!</p>
                {% endif %}
            </div>
        {% endif %}
    </div>
    
    <div class="task-form">
        <h2>Add New Task</h2>
        <form method="POST">
            <input type="text" name="title" placeholder="Task title" required>
            <textarea name="description" placeholder="Description" rows="3"></textarea>
            <input type="date" name="due_date" required>
            <select name="priority" required>
                <option value="high">High Priority</option>
                <option value="medium" selected>Medium Priority</option>
                <option value="low">Low Priority</option>
            </select>
            <select name="subject_id">
                <option value="">No Subject</option>
                {% for subject in subjects %}
                <option value="{{ subject.id }}">{{ subject.name }}</option>
                {% endfor %}
            </select>
            <textarea name="notes" placeholder="Initial notes (optional)" rows="2"></textarea>
            <button type="submit" class="btn btn-primary">Add Task</button>
        </form>
        
        <h2 style="margin-top: 2rem;">Add New Subject</h2>
        <form method="POST">
            <input type="text" name="new_subject" placeholder="Subject name (e.g., Math)" required>
            <button type="submit" class="btn btn-primary">Add Subject</button>
        </form>
        
        {% if subjects %}
        <h3>Your Subjects:</h3>
        <ul>
            {% for subject in subjects %}
            <li>
                {{ subject.name }}
                <a href="/delete_subject/{{ subject.id }}" 
                   onclick="return confirm('Delete {{ subject.name }}?')" 
                   style="color: red; margin-left: 10px;">Ã—</a>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
        
        <div style="margin-top: 2rem; padding: 1rem; background: #f0f0f0; border-radius: 5px;">
            <h3>ğŸ¯ Progress Tracking Tips:</h3>
            <ul>
                <li>Click any task to add progress notes</li>
                <li>Track what you've completed</li>
                <li>Note where you need help</li>
                <li>Search now includes note content</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}